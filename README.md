## Практическая работа №16. Вуйко Ярослава, ЭФМО-01-25

Интеграционное тестирование API. Использование Docker для тестовой БД. 18.12.2025

## Цели работы
1. Освоить интеграционное тестирование REST API: проверка «маршрут → хендлер → сервис → репозиторий → реальная БД».
2. Научиться поднимать изолированную тестовую среду БД в Docker.
3. Освоить 2 подхода к инфраструктуре тестов
4. Научиться инициализировать схему БД (миграции/auto-migrate), сидировать тестовые данные, очищать окружение.
5. Внедрить интеграционные проверки CRUD-эндпоинтов (статусы, заголовки, JSON-ответы, эффекты в БД).



## Структура проекта

```
.
├── cmd/
│   └── api/
│       └── main.go
├── integretion/
│   ├── notes_integration_test.go
│   ├── swagger.json
│   └── swagger.yaml
├── internal/
│   ├── db/
│   │   └── migrate.go
│   ├── httpapi/
│   │   └── handlers.go
│   ├── models/
│   │   └── note.go
│   ├── repo/
│   │   └── note.go
│   └── service/
│       └── service.go
├── docker-compose.yml
├── go.mod
├── go.sum
├── Makefile
└── README.md
```



### Запуск докера
<img width="1413" height="166" alt="image" src="https://github.com/user-attachments/assets/c700950d-6e5e-4dff-b287-132beee50c38" />

### Запук тестов
<img width="1102" height="602" alt="2025-12-18_19-56-22" src="https://github.com/user-attachments/assets/75075d5e-582a-46c7-8384-24a58927580e" />

### docker compose ps 
<img width="1329" height="138" alt="2025-12-18_19-59-17" src="https://github.com/user-attachments/assets/b75053f8-9e03-49cc-9ea7-f4fb71fa6ea2" />

## Выводы
В рамках работы были реализованы интеграционные тесты, проверяющие создание заметки (POST /notes), получение существующей заметки (GET /notes/:id) и корректную обработку запроса к несуществующему ресурсу (404 Not Found) с использованием реальной базы данных PostgreSQL, запущенной в Docker-контейнере. Тесты выполняются на отдельной тестовой БД и валидируют HTTP-статусы и структуру JSON-ответов.



### Требования
- Go 1.21 или выше


## Ответы на контрольные вопросы:
1. Чем интеграционные тесты отличаются от модульных? Когда целесообразно использовать каждый вид?
Модульные тесты проверяют отдельные функции или методы в изоляции, используя моки для зависимостей, а интеграционные тесты проверяют связку нескольких слоёв приложения (API, бизнес-логику, БД). Unit-тесты удобны для быстрой проверки логики и регрессий, интеграционные — для проверки работы всей системы в связке.
2. Зачем использовать Docker для БД, если локально уже есть PostgreSQL/MySQL?
Docker обеспечивает повторяемость и изоляцию среды, предотвращая влияние локальной БД на тесты, а также позволяет стартовать с чистой схемой и данными, гарантируя одинаковое поведение для всех разработчиков и CI.
3. Плюсы и минусы подходов docker-compose и testcontainers-go для интеграций.
docker-compose прост в использовании и прозрачен, но требует ручного управления контейнерами и сложнее интегрировать в CI. testcontainers-go полностью изолирован, поднимает контейнеры автоматически в коде и хорошо подходит для CI, но требует зависимости и немного больше кода.
4. Как обеспечить независимость интеграционных тестов (данные, транзакции, порядок)?
Используют отдельную тестовую БД или схему, очищают таблицы между тестами (TRUNCATE), применяют транзакции с rollback и создают фикстуры для начальных данных, чтобы тесты могли выполняться в любом порядке.
5. Как вы бы тестировали пагинацию и фильтрацию в списковых эндпоинтах?
Создаю набор тестовых данных, делаю запросы с параметрами limit/offset и фильтрами, проверяю, что возвращённое множество соответствует ожиданиям по количеству и содержанию, и что структура ответа корректна.
6. Какие риски несут «ломающие» миграции и как их безопасно применять в тестах?
Ломающие миграции могут удалять данные или менять схему несовместимо с текущим кодом. В тестах безопасно применять их на отдельной тестовой БД, которая может быть сброшена, или использовать idempotent-миграции, чтобы не нарушать состояние.
7. Как организовать запуск интеграционных тестов в CI?
Поднимают тестовую БД через Docker, экспортируют DSN в переменные окружения, запускают тесты go test ./integration/..., а после тестов удаляют контейнеры, обеспечивая чистую и воспроизводимую среду.





